{% load static %}
{% load prices %}
{% load material_form %}

{% block head %}
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sample Stripe Subscription Payment Form</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    {% include 'material/includes/material_css.html' %}
    {% include 'material/includes/material_js.html' %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="{%  static 'css/django_stripe/pricing.css' %}">
    <link rel="stylesheet" href="{%  static 'css/django_stripe/store.css' %}">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>
{% endblock %}

<body>
 <main id="main" class="loading">
{% block intro %}
    <header>
<h1 class="title">Subscription Options</h1>
    </header>
{%  endblock %}


{% block prices %}

    <! ––  Thanks to https://codepen.io/kresogalic/pen/dGzvRV ––>
    <div class="pricing-table">

    {% for price in product.prices %}
            <div class="pricing-option">
                <hr />
                <p>{{ price.description  }}</p>
                <hr/>
                <div class="price">
                    <div class="front">
                        <span class="price">{% block price %}{{ price.currency | currency_symbol }}{{ price.unit_amount | to_decimal_currency }} {%  endblock %} / {{price.recurring.interval}}</span>
                    </div>
                    <div class="back">
                        <a id="{{ price.id }}" href="#" class="button" onclick="onPriceClick(event)">Purchase now</a>
                    </div>
                </div>
            </div>
    {%  endfor %}

    </div>

{%  endblock %}


{% block payment_methods %}



<section id="new-payment-method">

    <div id="checkout">
      <form id="payment-form" method="POST" action="/orders">
        <p class="instruction"><span>Complete your payment details below</p>
        <section>
          <h2>Shipping &amp; Billing Information</h2>
          <fieldset class="with-state">
            <label>
              <span>Name</span>
              <input name="name" class="field" placeholder="Jenny Rosen" required>
            </label>
            <label>
              <span>Email</span>
              <input name="email" type="email" class="field" placeholder="jenny@example.com" required>
            </label>
            <label>
              <span>Address</span>
              <input name="address" class="field" placeholder="185 Berry Street Suite 550">
            </label>
            <label class="city">
              <span>City</span>
              <input name="city" class="field" placeholder="San Francisco">
            </label>
            <label class="state">
              <span>State</span>
              <input name="state" class="field" placeholder="CA">
            </label>
            <label class="zip">
              <span>ZIP</span>
              <input name="postal_code" class="field" placeholder="94107">
            </label>
            <label class="select">
              <span>Country</span>
              <div id="country" class="field US">
                <select name="country">
                  <option value="AU">Australia</option>
                  <option value="AT">Austria</option>
                  <option value="BE">Belgium</option>
                  <option value="BR">Brazil</option>
                  <option value="CA">Canada</option>
                  <option value="CN">China</option>
                  <option value="DK">Denmark</option>
                  <option value="FI">Finland</option>
                  <option value="FR">France</option>
                  <option value="DE">Germany</option>
                  <option value="HK">Hong Kong</option>
                  <option value="IE">Ireland</option>
                  <option value="IT">Italy</option>
                  <option value="JP">Japan</option>
                  <option value="LU">Luxembourg</option>
                  <option value="MY">Malaysia</option>
                  <option value="MX">Mexico</option>
                  <option value="NL">Netherlands</option>
                  <option value="NZ">New Zealand</option>
                  <option value="NO">Norway</option>
                  <option value="PL">Poland</option>
                  <option value="PT">Portugal</option>
                  <option value="SG">Singapore</option>
                  <option value="ES">Spain</option>
                  <option value="SE">Sweden</option>
                  <option value="CH">Switzerland</option>
                  <option value="GB">United Kingdom</option>
                  <option value="US" selected="selected">United States</option>
                </select>
              </div>
            </label>
          </fieldset>
          <p class="tip">Select another country to see different payment options.</p>
        </section>
        <section>
          <h2>Payment Information</h2>
          <nav id="payment-methods">
            <ul>
              <li>
                <input type="radio" name="payment" id="payment-card" value="card" checked>
                <label for="payment-card">Card</label>
              </li>
            </ul>
          </nav>
          <div class="payment-info card visible">
            <fieldset>
              <label>
                <span>Card</span>
                <div id="card-element" class="field"></div>
              </label>
            </fieldset>
          </div>
          <div class="payment-info redirect">
            <p class="notice">You’ll be redirected to the banking site to complete your payment.</p>
          </div>
          <div class="payment-info receiver">
            <p class="notice">Payment information will be provided after you place the order.</p>
          </div>
        </section>
        <button class="payment-button" type="submit">Pay</button>
      </form>
      <div id="card-errors" class="element-errors"></div>
    </div>
    <div id="confirmation">
      <div class="status processing">
        <h1>Completing your order…</h1>
        <p>We’re just waiting for the confirmation from your bank… This might take a moment but feel free to close this page.</p>
        <p>We’ll send your receipt via email shortly.</p>
      </div>
      <div class="status success">
        <h1>Thanks for your order!</h1>
        <p>Woot! You successfully made a payment with Stripe.</p>
        <p class="note">We just sent your receipt to your email address, and your items will be on their way shortly.</p>
      </div>
      <div class="status receiver">
        <h1>Thanks! One last step!</h1>
        <p>Please make a payment using the details below to complete your order.</p>
        <div class="info"></div>
      </div>
      <div class="status error">
        <h1>Oops, payment failed.</h1>
        <p>It looks like your order could not be paid at this time. Please try again or select a different payment option.</p>
        <p class="error-message"></p>
      </div>
    </div>


  <button id="submit" onclick="subscribe()" type="submit">
    Subscribe
  </button>
</section>

{%  endblock %}

 </main>
{{ js_vars|json_script:"context" }}


<script>
    let selectedPriceId = null;

    function onPriceClick(event){
        selectedPriceId = event.target.id;
        document.querySelector("#payment-methods-list").style.display = "block";
        //document.querySelector("#submit-section").style.display = "block";
    }

    function onPaymentMethodClick(event){
        hideCard();
    }

    function onNewPaymentMethodClick(){
        console.log('Running on new payment methods')
        showCard();
    }



    function createSubscription(selectedPaymentMethodId, subscriptionUrl) {
        console.log('Creating subscription');
        axios.post(subscriptionUrl, {
            default_payment_method: selectedPaymentMethodId,
            price_id: selectedPriceId
        }).then(console.log);
    }

</script>


<script>
  const csrfToken =  document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  axios.defaults.headers.post['X-CSRFToken'] = csrfToken
  axios.defaults.headers.put['X-CSRFToken'] = csrfToken
  axios.defaults.headers.delete['X-CSRFToken'] = csrfToken
  const context = JSON.parse(document.getElementById('context').textContent);
  const stripe = Stripe(context.stripe_public_key);
  const hidePostalCode = context.hide_postal_code;
  const subscriptionUrl = context.subscription_api_url;
  const setupIntentsUrl = context.setup_intents_url;
  const elements = stripe.elements();
  const card = "#card-element"; // HTML div to mount card;
  const cardSubmit = document.querySelector("#submit");
  const cardElement = elements.create('card', {hidePostalCode: hidePostalCode});
  let submitDisabled = true;

  function showCard() {
      cardElement.mount(card);
  }

  function hideCard(){
    cardElement.unmount();
  }

  cardElement.on('change', function(e) {
      cardSubmit.disabled = !e.complete;
      // manage errors
  });

  if (!context.has_payment_methods){
      showCard();
  }

  function subscribe() {
      let selectedPaymentMethodId = getSelectedPaymentMethod();
      console.log('Found selected payment method id', selectedPaymentMethodId)
      if (selectedPaymentMethodId){
        console.log('creating subscription')
        createSubscription(selectedPaymentMethodId, subscriptionUrl)
      } else {
          console.log('Creating setupIntent');
          axios.post(setupIntentsUrl)
              .then((response) => {
               let setupIntent = response.data;
              console.log("confirming card setup with setupIntent", setupIntent);
              stripe.confirmCardSetup(setupIntent.client_secret, {
                  payment_method: {
                      card: cardElement,
                  },
              })
              .then(function (result) {
                  setupIntent = result.setupIntent;
                  if (setupIntent) {
                      console.log("setupIntent confirmed");
                      selectedPaymentMethodId = setupIntent.payment_method;
                      console.log("selectedPaymentMethodId", selectedPaymentMethodId);
                      createSubscription(selectedPaymentMethodId, subscriptionUrl)
                  } else if (result.error) {
                      // Handle result.error
                      console.log(result.error);
                  }
              });
          });
      }
  }

</script>


</body>
</html>